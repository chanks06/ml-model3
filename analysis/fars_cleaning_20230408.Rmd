---
title: "fars3"
output: html_document
date: "2023-04-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/charleshanks/repos/ml-model3/datasets')
```

```{r}
library(tidyverse)
library(tidytext)
library(caret)
library(fastDummies)
library(randomForest)
```

Cleaning up joined dataset: 

```{r}

ds = read_csv('drivers_2020.csv')

ds %>% group_by(drinkingname) %>% count()

ds = ds %>% rename(died_at_scene = drugsname ) %>% rename(drugs_involved = alc_detname) %>% select(-doaname)

colnames(ds)

ds = ds %>% select(-impact1name...15, -drunk_dr, -veh_no...4, -st_case...40, -st_case...28)

ds = ds %>% rename(st_case = st_case...1)

ds = ds %>% select(-per_no)
```
Numericle variables 
ve_forms
day
hour
age
latitude
longitud
fatals
dr_hgt
dr_wgt
prev_acc
prev_dwi
prev_spd
prev_oth

```{r}
num_cols = c('ve_forms', 'day', 'hour','age','latitude','longitud','fatals','dr_hgt','dr_wgt','prev_acc','prev_dwi','prev_spd','prev_oth')

#coercing to numeric: 
ds[(num_cols)] = lapply(ds[(num_cols)], as.numeric)

#the prev_ cols have 98s/99s indicating unreported or unknown, we should make these NA. 
ds[c('prev_acc','prev_dwi','prev_spd','prev_oth')] = lapply(ds[c('prev_acc','prev_dwi','prev_spd','prev_oth')], function(x) ifelse(x == 99 | x == 98, NA, x ))
        
#the string columns should be factors: 
char_vars = ds %>% select_if(is.character) %>% colnames()

ds[char_vars] = lapply(ds[char_vars], as.factor)

#st_case is an ID number for each case and is no longer necessary: 
ds = ds %>% select(-st_case)

#extricatname and drinkingname  

#county is code, should be double 
ds$county = as.factor(ds$county)

#rest_usename and rest_misname have "unknown"....much much of the data is unknown for these categories? 

ds %>% group_by(rest_misname) %>% count()

#should probably change "reported as unknown" to NA - it is not valuable information. 
class(ds$rest_misname)

#ds$rest_usename = ifelse(ds$rest_usename == 'Reported as Unknown'| ds$rest_usename == 'Not Reported', NA, ds$rest_usename)

ds$rest_usename = na_if(ds$rest_usename,"Reported as Unknown")
ds$rest_usename = na_if(ds$rest_usename,"Not Reported")

#extricatname
ds %>% group_by(extricatname) %>% count()

ds$extricatname = na_if(ds$extricatname,"Unknown")

#drugs_involved has way too much missing data, I think I should drop it. 
ds %>% group_by(drugs_involved) %>% count() %>% mutate(prop = n/nrow(ds))

ds = ds %>% select(-drugs_involved)

#i'm wondering about the correlation between make of car and if there were drinkers invovled


```

this is my response variable: drinkingname
```{r}
#drinkingname is the variable we will use to determine class
ds = ds %>% mutate(drinkingname = ifelse(drinkingname %in% c('Not Reported','Reported as Unknown'),NA, drinkingname)) %>% relocate(drinkingname)

ds = ds %>% mutate(was_drinking = as.factor(ifelse(drinkingname == 4, 'yes','no'))) %>% relocate(was_drinking) 

#removing other drink col 

ds = ds %>% select(-drinkingname)

#now I need to remove cols with NAs

ds = ds %>% drop_na()
```


I think profiling drinking driver based on make of car will not be a great choice 
```{r}

ds = ds %>% select(-makename)
```

looking for other 'not reported'/'unknown' data and converting to NA: 
```{r}
lapply(ds, function(x) sum(grepl('Not Reported',x)))

for(i in colnames(ds))
{
  ds[i][ds[i] == "Not Reported"] = NA
}


#running lapply again to check: 
lapply(ds, function(x) sum(grepl('Not Reported',x)))
#that kind of worked...except for inj_sevname and m_harmname


ds %>% select(harm_evname, inj_sevname, m_harmname) %>% unique()



#check
lapply(ds, function(x) sum(grepl('[Uu]nknown',x)))

for (col in names(ds)) 
{
    ds[[col]][grepl("Unknown/Not Reported", ds[[col]], ignore.case = TRUE)] = NA
}

#double check for unknown
ds %>% filter(grepl("Reported",harm_evname, ignore.case = T)) %>% select(harm_evname)

```
Looking at cleaned-up dataset 

```{r}
ds.clean = ds %>% drop_na()

ds.clean %>% group_by(was_drinking) %>% count() %>% mutate(prop = n/nrow(ds.clean))

skim(ds.clean)
```
We may want to drop the county columns....

```{r}
ds.clean = ds.clean %>% select(-county)
```


The average weight looks wrong. There must be some code in there that is inflating. 

```{r}
unique(ds.clean$dr_hgt)
ds.clean = ds.clean %>% 
  mutate(dr_hgt = ifelse(dr_hgt == 999, NA, dr_hgt)) 

unique(ds.clean$dr_wgt) %>% sort()
ds.clean = ds.clean %>% 
  mutate(dr_wgt = ifelse(dr_wgt == 999, NA, dr_wgt)) 
```
After transforming 999 to NAs, many NAs to hold on to this characteristics. We must let these go. 

```{r}
ds.clean = ds.clean %>% drop_na()
```


Checking back to see our breakdown of class: 

```{r}
ds.clean %>% group_by(was_drinking) %>% count() %>% mutate(prop = n/nrow(ds.clean))

colnames(ds.clean)

ds.clean = ds.clean %>% rename(num_vehicles = veh_no...41, impact = impact1name...43)

#died at scene: 
unique(ds.clean$died_at_scene)
ds.clean = ds.clean %>% mutate(died_at_scene = (ifelse(died_at_scene == 'Not Applicable', 'no', 'died on scene or en route'))) 

ds.clean %>% group_by(died_at_scene) %>% count()
```
pushing numerical cols to the front: 

```{r}
ds.clean = ds.clean %>% relocate(fatals:num_vehicles,latitude,longitud, dr_hgt:prev_oth) %>% relocate(was_drinking)
```

```{r}
saveRDS(ds.clean, file = '/Users/charleshanks/repos/ml-model3/datasets/drivers-clean.rds')
```

Okay, I think we are now good to go. 








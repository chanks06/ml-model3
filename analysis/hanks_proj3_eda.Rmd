---
title: "Project 3"
author: "Charles Hanks & Karol Orozco"
date: "03/16/2023"
output:
  pdf_document:
    df_print: kable
    fig_width: 11
    fig_height: 8
  html_document:
    df_print: paged
---


## Setup
```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = '/Users/charleshanks/repos/ml-model3') 

library(tidyverse)
library(tidytext)
library(caret)
library(fastDummies)
library(randomForest)
library(RCurl)
# https://www.openml.org/d/1590

#preventing scientific notation for numerical outputs
options(scipen=999)
```


```{r}
raw_income = read_csv('datasets/openml_1590.csv', na=c("?"))

income = read_csv("datasets/openml_1590.csv", na=c("?")) %>%
  drop_na() %>%
  mutate(income_above_50k = class==">50K") %>%
  select(-class) %>%
  dummy_cols(remove_selected_columns = T)

View(income)
```

## Some questions about the data

Please try at least a few of the following:

* Run PCA on the dataset. How many principal components do you need to explain half the variation? 
* Can you give some interpretation of the principal components?
* Look at the scree plot. How many PCs would you choose based on that?
* Are the first few Principal Components good predictors of income_above_50k?
* How well can you predict income_above_50k using the first 5 or 6 principal components? How about only the first 2?
* Can you gain any insights into the data based on k-means clustering? 
* Can you visualize and interpret some or all of your clusters?
* Using any and all techniques we have learned, build the best predictive model for income_above_50k that you can. What are your best features? What model did you use? What interpretations can you draw?
* What metric can you use to assess model performance? Why is that a good choice of metric in this case?
* What are some key insights you found through your analysis?

Please remember: a statement like "PC2 is not a meaningful predictor for our modeling problem" is a great insight; sometimes things don't work!

10 pts PCA

* analysis and interpretation of factor loadings
* discussion of scree plot and/or analysis of some density plots of PCs
* meaningful interpretation / discussion of conclusions 

10 pts k-means

* discussion for choosing number of clusters
* analysis of cluster centers
* bivariate chart(s) against meaningful variables and/or analysis of density plots
* meaningful interpretation / discussion of conclusions 

10 pts supervised learning

* feature engineering / selection, whether with PCA or otherwise
* interpretation of variable importance, coefficients if applicable
* justification of choice of metric
* discussion of choice or tuning of hyperparameters, if any
* meaningful discussion of predictive power and conclusions from model

Please be prepared to 

* Submit your Rmd + compiled html or pdf, *and*
* Present your findings to the class in a compelling way, speaking for 10 minutes or so. You don't need to cover everything in your analysis that you submit to me, focus on the fun / interesting / compelling highlights or challenges.


####

# BACKGROUND

- Prediction task is to determine whether a person makes over 50k a year. Data from 1994 Census database. 
- fnlwgt: demographic background of the people - people with similar demographic characteristics should have similar weights. 


```{r}
library(skimr)
skim(income)

ggplot(income, aes(x = `capital-loss`)) + geom_histogram()
#I should log capital-gain and capital-loss
#definition: capital gain refers to the increase in the value of a capital asset when it is sold. A capital gain occurs when you sell an asset for more than what you originally paid for it. 

income = income %>% mutate(l_capital_gain = log(`capital-gain`), 
                  l_capital_loss = log(`capital-loss`)) %>% 
                        select(-`capital-gain`,-`capital-loss`)

#moving these cols back to front of dummy cols: 
income = income %>% relocate(l_capital_gain, l_capital_loss)

#converting -Inf to 0 in capital gains and losses: 
income = income %>% mutate(l_capital_gain = ifelse(l_capital_gain == '-Inf', 0, l_capital_gain),
                  l_capital_loss = ifelse(l_capital_loss == '-Inf', 0, l_capital_loss))

#I can't deal with these hyphens: 
income = income %>% rename_all(funs(str_replace_all(.,"-","_"))) %>% 
                rename_all(funs(tolower(.)))

```

# Exploratory Data Analysis 

```{r}
#what is education_num? 
#is NA retired? Unemployed? 
raw_income %>% ggplot(aes(x = age, fill = occupation)) + geom_histogram() + facet_wrap(~occupation)
#military is a younger person's occupation 
#exec-manegerial is very normally distributed 
```

Distribution of careers by gender 
```{r}
raw_income %>% 
  group_by(occupation,sex) %>% 
          count() %>% 
          ggplot(aes(x = occupation, y = n, fill = sex)) + geom_col() + coord_flip()
```

```{r}
raw_income %>% group_by(education, workclass) %>% count() %>% ggplot(aes(x = n, y = education, fill = workclass)) + geom_col()
```
How about age vs. relationship? 
```{r}
raw_income %>% group_by(relationship) %>% summarize(avg_age= mean(age))
raw_income %>% group_by(sex) %>% count()
#there are twice as many men in this dataset....may need to downsample by gender later in the game. This may lead to implicit bias toward men making more than 50k in the model. 

raw_income %>% group_by(sex, relationship) %>% count()
#there is 1 female husband, look like this dataset does not take into account the difference between gender and sex


```
# Principal Component Analysis on income dataset

```{r}
pr_income = prcomp(x = select(income,-income_above_50k), scale = T, center = T)
summary(pr_income)
#it takes 37 PCA features to explain 50% of the variation in the data. 
```

```{r}
screeplot(pr_income, type = "lines")
#elbow is around pc5
```
Factor loadings: 

```{r}
pr_income$rotation

#PC1 : works longer hours, less private work, older
#PC2 : lower education level, less local government, more private work, younger
#PC3 : older, less private sector (not very meaningfu predictor) 
#PC4 : younger, more educated 
#PC5 : ...
#PC6 : public workers 
#PC7 : work long hours in private sector 
#PC8 : low fnlwgt...not quite sure how to interpret this variable yet. less private sector work 

#the min/max seems to be around abs(+/-.2)

```
```{r}
rownames_to_column(as.data.frame(pr_income$rotation)) %>% 
  select(1:6) %>% 
    filter(abs(PC1) >= 0.2 | abs(PC2) >= 0.2 | abs(PC3) >= 0.2 | abs(PC4) >= 0.2 | abs(PC5) >= 0.2)

# PC1 : married men 
# PC2 : uneducated 
# PC3 : pacific islander immigrants 
# PC4 : young, single folk 
# PC5 : mexican immigrants 

```
```{r}
prc = bind_cols(select(income, income_above_50k), as.data.frame(pr_income$x)) %>%
  select(1:6) %>%
    rename("married_men" = PC1, "uneducated" = PC2, "pac_isl_immigrants" = PC3, "young_single"= PC4, "mexican_immigrants" = PC5)



prc %>%
pivot_longer(cols = -income_above_50k, names_to = "component", values_to = "loading") %>% mutate(income_above_50k = as.factor(income_above_50k)) %>%
ggplot(aes(loading, fill=income_above_50k)) +
geom_density(alpha = 0.5) +
facet_grid(.~component)

#principal compoenents "married_men" and "uneducated" - given this plot maybe my "uneducated" label is incorrect. 

#PC1 and PC4 are good predictors of income_above_50k, but not the rest. 

```

Making a model using only  5 PCs: 

```{r}
prc = prc %>% mutate(income_above_50k = ifelse(income_above_50k == TRUE, "y", "n"))

prc = prc %>% mutate(income_above_50k = as.factor(income_above_50k))


ctrl <- trainControl(method = "cv", number = 3, classProbs = TRUE)

prc_index <- createDataPartition(prc$income_above_50k, p = 0.80, list = FALSE)
train <- prc[prc_index, ]
test <- prc[-prc_index, ]

model.pca =train(income_above_50k ~ .,
             data = train, 
             method = "rf",
             metric = "ROC",
             trControl = ctrl)

importance = varImp(model.pca)

plot(importance)
#pc1 "married_men" is the most predictive of class 

```

